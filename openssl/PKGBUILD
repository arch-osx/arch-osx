# PKGBUILD autocreated by ABStoOSX 0.2
# $Id
# ArchLinux Maintainer: Pierre Schmitz <pierre@archlinux.de>

pkgname=openssl
pkgver=0.9.8j
pkgrel=2
pkgdesc='The Open Source toolkit for Secure Sockets Layer and Transport Layer Security'
arch=('macx86')
url='http://www.openssl.org'
license=('custom:BSD')
depends=('zlib')
makedepends=('perl')
optdepends=('ca-certificates'
            'perl')
options=('!makeflags')
source=("http://www.openssl.org/source/${pkgname}-${pkgver}.tar.gz" \
        'http://www.linuxfromscratch.org/patches/downloads/openssl/openssl-0.9.8j-fix_manpages-1.patch')
md5sums=('a5cb5f6c3d11affb387ecf7a997cac0c'
         '04a6a88c2ee4badd4f8649792b73eaf3')

build() {
	cd $srcdir/$pkgname-$pkgver

	patch -p1 -i $srcdir/openssl-0.9.8j-fix_manpages-1.patch  || return 1

    # manual universal build
    arches="i386 x86_64"
    binaries="bin/openssl lib/engines/lib4758cca.so lib/engines/libaep.so lib/engines/libatalla.so lib/engines/libcapi.so lib/engines/libchil.so lib/engines/libcswift.so lib/engines/libgmp.so lib/engines/libnuron.so lib/engines/libsureware.so lib/engines/libubsec.so lib/libcrypto.0.9.8.dylib lib/libcrypto.a lib/libcrypto.dylib lib/libssl.0.9.8.dylib lib/libssl.a lib/libssl.dylib"

    original_cflags="$CFLAGS"
    original_ldflags="$LDFLAGS"
    for arch in $arches; do
        echo "building $arch"

        make clean
        CFLAGS="-arch $arch $(echo $original_cflags | sed 's^-arch [a-z0-9_][a-z0-9_]*^^g')"
        LDFLAGS="-arch $arch $(echo $original_ldflags | sed 's^-arch [a-z0-9_][a-z0-9_]*^^g')"
        CC="gcc -arch $arch"

    	configuration="--prefix=/opt/arch --openssldir=/opt/arch/etc/ssl shared zlib"

        case "$arch" in
            "i386")
                ./Configure $configuration darwin-i386-cc
                ;;
            "x86_64")
                ./Configure $configuration darwin64-x86_64-cc
                ;;
        esac

        make || return 1
        make test  || return 1
        mkdir -p $startdir/src/build/$arch
        make INSTALL_PREFIX=$startdir/src/build/$arch MANDIR=/opt/arch/share/man install
    done
  
	make INSTALL_PREFIX=$pkgdir MANDIR=/opt/arch/share/man install

    echo "making universal binaries"
    for binary in $binaries; do
        rm $startdir/pkg/opt/arch/$binary
        lipo -create $startdir/src/build/*/opt/arch/$binary -output $startdir/pkg/opt/arch/$binary
    done

    sed -i~ -e 's^EX_LIBS= *-lz^EX_LIBS= -L/opt/arch/lib -lz^g' Makefile

	install -D -m644 LICENSE $pkgdir/opt/arch/share/licenses/$pkgname/LICENSE
}
