# PKGBUILD autocreated by ABStoOSX 0.2
# $Id
# ArchLinux Maintainer: Juergen Hoetzel <juergen@archlinux.org>
pkgname=clisp
pkgver=2.47
pkgrel=2
pkgdesc="ANSI Common Lisp interpreter, compiler and debugger"
arch=('macx86')
license=('GPL')
url="http://clisp.cons.org/"
depends=('readline' 'libsigsegv')
#makedepends=('ffcall')
options=('!makeflags')
source=(http://downloads.sourceforge.net/sourceforge/clisp/clisp-${pkgver}.tar.bz2)
md5sums=('8fa89bb13e865fc7c7150b82682f35af')

build() {
  cd ${startdir}/src/${pkgname}-${pkgver}

  # straight universal fails, as there are some dependencies on type sizes

  noarch_cflags="$(echo $CFLAGS | sed -e 's^-arch [a-z0-9_][a-z0-9_]*^^g')"
  noarch_ldflags="$(echo $LDFLAGS | sed -e 's^-arch [a-z0-9_][a-z0-9_]*^^g')"
  unset CFLAGS CXXFLAGS CPPFLAGS

  #no ffcall on x86_64 yet
  arches="i386 x86_64"
  binaries=""

  for arch in $arches; do
    echo "building $arch"
    make clean
    case "$arch" in
        *)
            ./configure --prefix=/opt/arch --with-readline --without-ffcall src CC="gcc -arch $arch $noarch_cflags" || return 1
            ;;
    esac

    cd src
    ./makemake --prefix=/opt/arch --with-readline > Makefile #--with-ffcall --with-dynamic-ffi > Makefile
    make || return 1
    sed -i~ -e 's,http://www.lisp.org/HyperSpec/,http://www.lispworks.com/reference/HyperSpec/,g' config.lisp
    make || return 1
    make DESTDIR=${startdir}/src/build/$arch install || return 1
  done

  make DESTDIR=${startdir}/pkg/ install || return 1

  # Remove debugging symbols
  rm -rf ${pkgdir}/opt/arch/bin/clisp.dSYM

  echo "making universal binaries"
  for binary in $binaries; do
      rm $startdir/pkg/opt/arch/$binary
      lipo -create $startdir/src/build/*/opt/arch/$binary -output $startdir/pkg/opt/arch/$binary
  done

}
