# ArchOSX Maintainer: Tom Wambold <tom5760@gmail.com>
# ArchLinux Maintainer: Dan McGee <dan@archlinux.org>
# ArchLinux Maintainer: Aaron Griffin <aaron@archlinux.org>
pkgname=libarchive
pkgver=2.6.1
pkgrel=3
pkgdesc="library that can create and read several streaming archive formats"
arch=(macx86)
url="http://people.freebsd.org/~kientzle/libarchive/"
license=('BSD')
groups=('base')
depends=('zlib' 'bzip2')
source=(http://libarchive.googlecode.com/files/libarchive-$pkgver.tar.gz)

# pacman.static build fails unless we keep the libtool files (or unless we link
# the missing symbols inside the libarchive .a static lib, but that is dirty)
options=(libtool)

build() {
  
  #CFLAGS="-arch i686 $(echo $CFLAGS | sed 's/-arch [A-Za-z0-9_-]*//g')"
  #LDFLAGS="-arch i686 $(echo $LDFLAGS | sed 's/-arch [A-Za-z0-9_-]*//g')"

  cd $startdir/src/$pkgname-$pkgver
  ./configure --prefix=/opt/arch --without-lzmadec --disable-dependency-tracking

  make || return 1
  make DESTDIR=$startdir/pkg install

  # install license
  mkdir -p $startdir/pkg/opt/arch/share/licenses/libarchive
  install -m644 COPYING $startdir/pkg/opt/arch/share/licenses/libarchive/
  find $startdir/pkg -name \*.la -delete

  # manual universal build, builds correctly
  # but apparently does not work when running makepkg
  # maybe for various external reasons, such as using wrong sdk
  #arches="i686 x86_64"
  #binaries="opt/arch/bin/faked opt/arch/lib/libfakeroot/libfakeroot-0.dylib opt/arch/lib/libfakeroot/libfakeroot.dylib"
  #
  #original_cflags="$CFLAGS"
  #original_ldflags="$LDFLAGS"
  #for arch in $arches; do
  #  echo "building $arch"
  #  make clean
  #  CFLAGS="-arch $arch $original_cflags"
  #  LDFLAGS="-arch $arch $original_ldflags"
  #  ./configure --prefix=/opt/arch --libdir=/opt/arch/lib/libfakeroot --disable-static
  #  make || return 1
  #  mkdir -p $startdir/src/build/$arch
  #  make DESTDIR=$startdir/src/build/$arch install
  #done
  #
  #make DESTDIR=$startdir/pkg install
  #
  #for binary in $binaries; do
  #  rm $startdir/pkg/$binary
  #  lipo -create $startdir/src/build/*/$binary -output $startdir/pkg/$binary
  #done

}

md5sums=('9d9f83947ee9d5732289ed48d00e3743')
sha256sums=('4d0ad4e5c33aa9725c7d92a42ae605815781372db949cd9906945e6c0d85c179')

